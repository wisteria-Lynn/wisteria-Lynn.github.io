(window.webpackJsonp=window.webpackJsonp||[]).push([[6],{594:function(e,s,t){"use strict";t.r(s);var a=t(697),i=t(629);for(var n in i)"default"!==n&&function(e){t.d(s,e,function(){return i[e]})}(n);t(679),t(680);var r=t(53),c=Object(r.a)(i.default,a.a,a.b,!1,null,"2adb31e5",null);c.options.__file="src/pages/project/chat/chat.vue",s.default=c.exports},629:function(e,s,t){"use strict";t.r(s);var a=t(630),i=t.n(a);for(var n in a)"default"!==n&&function(e){t.d(s,e,function(){return a[e]})}(n);s.default=i.a},630:function(e,s,t){"use strict";Object.defineProperty(s,"__esModule",{value:!0});var a=t(601),i=t(602);s.default={name:"chat",data:function(){return{chatLoginName:"",ws:"",searchName:"",chatDetail:{chatName:"",type:"",readay:""},chatLineList:[],chatList:[],message:"",localMessage:JSON.parse(sessionStorage.getItem("messageList"))||[],localIndex:"",messageList:[],errorMessage:"",isShowError:!1,sysMessages:[]}},methods:{send:function(){if(!window.WebSocket)return this.errorMessage="服务器关闭，请退出重新登录",void(this.isShowError=!0);if(""===this.chatDetail.chatName)return this.errorMessage="请选择聊天对象",void(this.isShowError=!0);if(""===this.message)return this.errorMessage="消息不能为空",void(this.isShowError=!0);if(2!==this.chatDetail.type)return this.errorMessage="你们还不是好友，不能聊天哦",void(this.isShowError=!0);if(!this.chatDetail.readay)return this.errorMessage="该好友不在线，不能聊天哦",void(this.isShowError=!0);var e={type:"message",sendName:this.chatLoginName,reciveName:this.chatDetail.chatName,message:this.message};this.ws.send(JSON.stringify(e)),this.message=""},chatClick:function(e){var s=this,t=this.messageList.findIndex(function(s,t,a){return s.chatName===e.username});if(t>-1&&this.messageList[t].msNum>0){this.$set(this.messageList[t],"msNum",0);var a=this.localMessage.findIndex(function(e,t,a){return e.name===s.chatLoginName});this.localMessage[a].list=this.messageList,sessionStorage.setItem("messageList",JSON.stringify(this.localMessage))}setTimeout(function(){var e=s.$refs.bottomScroll;e.scrollTop=e.scrollHeight},100),this.chatDetail={chatName:e.username,type:e.type,readay:e.readay},this.errorMessage="",this.isShowError=!1},getReadyLine:function(e,s){var t=this.chatLineList.filter(function(s,t,a){return s.username===e.username}),a=0!==t.length&&t[0].readay;return this.chatList[s].readay=a,a},getFrendList:function(){var e=this;(0,a.chatFriendList)({name:this.chatLoginName}).then(function(s){0!==s.code?e.layer.msg((0,i.codeText)(s.code)):e.chatList=s.data})},getMessNum:function(e){var s=this.messageList.filter(function(s,t,a){return s.chatName===e.username});return 0===s.length?0:s[0].msNum},getChatAddFriend:function(e,s){var t=this;(0,a.chatAddFriend)({sendName:"add"===s?this.chatLoginName:e.username,reciveName:"recive"===s?this.chatLoginName:e.username,type:s}).then(function(e){0!==e.code?t.layer.msg((0,i.codeText)(e.code)):t.getFrendList()})},wsClose:function(){this.ws.send(JSON.stringify({type:"close",username:this.chatLoginName})),this.ws.onclose()},loginout:function(){this.wsClose(),this.$router.push({name:"chatLogin"})}},created:function(){var e=this;console.log(this.$route.params.name);var s=this.$route.params.name||sessionStorage.getItem("chatLoginName");if(s){sessionStorage.setItem("chatLoginName",s),this.chatLoginName=s;var t=new WebSocket("ws://127.0.0.1:3001");this.ws=t,t.onopen=function(s){console.log("连接服务器成功");var t={type:"login",username:e.chatLoginName};e.ws.send(JSON.stringify(t)),e.getFrendList(),e.localIndex=e.localMessage.findIndex(function(s,t,a){return s.name===e.chatLoginName}),e.messageList=e.localIndex>-1?e.localMessage[e.localIndex].list:[]},t.onmessage=function(s){console.log(s.data);var t=JSON.parse(s.data);if("system"===t.type&&e.sysMessages.push(t.message),"userList"===t.type&&(e.chatLineList=t.message),"message"===t.type){var a=e.chatLoginName===t.sendName?t.reciveName:t.sendName,i=0;if(a!==e.chatDetail.chatName?i++:setTimeout(function(){var s=e.$refs.bottomScroll;s.scrollTop=s.scrollHeight},100),e.localIndex>-1){e.messageList=e.localMessage[e.localIndex].list;var n=e.messageList.findIndex(function(e,s,t){return e.chatName===a});n>-1?(e.messageList[n].chatArr.push({name:t.sendName,mess:t.message}),i>0&&e.$set(e.messageList[n],"msNum",e.messageList[n].msNum+i)):e.messageList.push({chatName:a,chatArr:[{name:t.sendName,mess:t.message}],msNum:i}),e.localMessage[e.localIndex].list=e.messageList}else e.messageList.push({chatName:a,chatArr:[{name:t.sendName,mess:t.message}],msNum:i}),e.localMessage.push({name:e.chatLoginName,list:e.messageList}),e.localIndex=e.localMessage.length-1;sessionStorage.setItem("messageList",JSON.stringify(e.localMessage))}},t.onclose=function(e){console.log("服务器关闭")},t.onerror=function(e){console.log("连接出错")},window.onunload=function(){e.wsClose()},window.onbeforeunload=function(){this.wsClose()}}else sessionStorage.removeItem("chatLoginName"),this.$router.push({name:"chatLogin"})}}},631:function(e,s,t){},632:function(e,s,t){},679:function(e,s,t){"use strict";var a=t(631);t.n(a).a},680:function(e,s,t){"use strict";var a=t(632);t.n(a).a},697:function(e,s,t){"use strict";var a=function(){var e=this,s=e.$createElement,t=e._self._c||s;return t("div",{staticClass:"chat"},[t("div",{staticClass:"chat-wrap"},[t("div",{staticClass:"chat-frame"},[t("div",{staticClass:"fram-side"},[t("div",{staticClass:"fram-side-head"},[t("span",[e._v(e._s(e.chatLoginName))]),e._v(" "),t("span",{staticClass:"cursor-point",on:{click:e.loginout}},[e._v("退出")])]),e._v(" "),t("div",{staticStyle:{height:"40px","line-height":"40px","padding-left":"5px"}},[e._v("\n\t\t\t\t\t好友列表("+e._s(e.chatList.length)+")\n\t\t\t\t")]),e._v(" "),t("div",{staticClass:"fram-side-search"},[t("el-input",{attrs:{size:"mini",placeholder:"请输入内容","suffix-icon":"el-icon-search"},model:{value:e.searchName,callback:function(s){e.searchName=s},expression:"searchName"}})],1),e._v(" "),t("div",{staticClass:"fram-side-list"},[t("div",{staticClass:"f-s-scroll scroll-style"},e._l(e.chatList,function(s,a){return t("div",{key:a,staticClass:"f-l-item",class:[s.username===e.chatDetail.chatName?"active":""],on:{click:function(t){e.chatClick(s)}}},[t("span",{staticClass:"f-l-name"},[e._v(e._s(s.username))]),e._v(" "),2===s.type?t("div",{staticStyle:{float:"right"}},[e.getMessNum(s)>0?t("span",{staticClass:"message-num chat-ms-num"},[e._v(e._s(e.getMessNum(s)))]):e._e()]):e._e(),e._v(" "),t("span",{staticClass:"f-l-isready"},[e._v(e._s(e.getReadyLine(s,a)?"在线":"离线"))]),e._v(" "),0===s.type?t("div",{staticStyle:{float:"right"}},[t("span",{staticClass:"btn btn-error chat-btn-reject"},[e._v("待通过")])]):e._e(),e._v(" "),1===s.type?t("div",{staticStyle:{float:"right"}},[t("span",{staticClass:"btn btn-success chat-btn-agree",on:{click:function(t){e.getChatAddFriend(s,"recive")}}},[e._v("接受")])]):e._e()])}),0)])]),e._v(" "),t("div",{staticClass:"fram-container"},[e.isShowError?t("div",{staticClass:"errorMssage"},[t("div",[t("el-alert",{attrs:{title:e.errorMessage,type:"warning","show-icon":"",closable:!1}})],1)]):e._e(),e._v(" "),t("div",{staticClass:"fram-head"},[t("div",[e._v(e._s(e.chatDetail.chatName))])]),e._v(" "),t("div",{staticClass:"fram-content"},[t("div",{ref:"bottomScroll",staticClass:"m-p-scroll scroll-style"},[t("div",{staticClass:"message-panel"},e._l(e.messageList,function(s){return s.chatName===e.chatDetail.chatName?t("div",e._l(s.chatArr,function(s){return t("div",{staticClass:"m-p-wrap"},[s.name===e.chatLoginName?t("div",{staticClass:"t-right"},[t("div",{staticClass:"m-p-name-1"},[e._v(e._s(s.name))]),e._v(" "),t("span",{staticClass:"m-p-text-1 right"},[e._v(e._s(s.mess))])]):t("div",{staticClass:"t-left"},[t("div",{staticClass:"m-p-name-2"},[e._v(e._s(s.name))]),e._v(" "),t("span",{staticClass:"m-p-text-2"},[e._v(e._s(s.mess))])])])}),0):e._e()}),0)])]),e._v(" "),t("div",{staticClass:"fram-input"},[t("div",{staticStyle:{padding:"0 2px"}},[t("el-input",{attrs:{type:"textarea",placeholder:"请输入内容"},nativeOn:{keyup:function(s){return"button"in s||!e._k(s.keyCode,"enter",13,s.key,"Enter")?e.send(s):null}},model:{value:e.message,callback:function(s){e.message=s},expression:"message"}})],1)]),e._v(" "),t("div",{staticClass:"fram-foot t-right"},[t("div",{staticStyle:{padding:"0 1px"}},[t("el-button",{on:{click:e.send}},[e._v("发送")])],1)])]),e._v(" "),t("div",{staticClass:"fram-rgiht"},[e._m(0),e._v(" "),t("div",{staticClass:"fram-right-content"},[t("div",{staticClass:"f-r-scroll scroll-style"},e._l(e.sysMessages,function(s){return t("div",[e._v(e._s(s))])}),0)])])])])])},i=[function(){var e=this.$createElement,s=this._self._c||e;return s("div",{staticClass:"fram-head"},[s("div",[this._v("系统消息")])])}];a._withStripped=!0,t.d(s,"a",function(){return a}),t.d(s,"b",function(){return i})}}]);
//# sourceMappingURL=6.17ea1d85d0699765574f.js.map